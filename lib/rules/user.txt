function getUser() {
  return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
}

function isAdmin() {
  return getUser().role == "admin";
}

match /users/{userId} {
  allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
  allow create: if request.auth != null
      && request.resource.data.keys().hasOnly(['email'])
}